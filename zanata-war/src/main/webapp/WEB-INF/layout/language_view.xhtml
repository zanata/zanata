<ui:composition xmlns="http://www.w3.org/1999/xhtml"
  xmlns:ui="http://java.sun.com/jsf/facelets"
  xmlns:h="http://java.sun.com/jsf/html"
  xmlns:f="http://java.sun.com/jsf/core"
  xmlns:s="http://jboss.org/schema/seam/taglib"
  xmlns:a4j="http://richfaces.org/a4j"
  xmlns:rich="http://richfaces.org/rich">

  <h1 class="l--push-all-0">
    #{languageTeamAction.locale.retrieveDisplayName()}
  </h1>

  <div class="panel l--push-top-1">
    <div class="panel__header">
      <div class="panel__header__actions">
        <s:div rendered="#{identity.loggedIn}"
          styleClass="dropdown dropdown--header dropdown--small dropdown--right dropdown--inline js-dropdown"
          id="more-actions">
          <a class="dropdown__toggle js-dropdown__toggle" href="#"
            title="#{msgs['jsf.tooltip.MoreActions']}"><i
            class="i i--ellipsis"></i></a>
          <h:form id="more-action-form" styleClass="l--push-bottom-0">
            <ul class="dropdown__content js-dropdown__content" role="content"
              aria-labelledby="dropdownContent">
              <s:fragment rendered="#{not languageTeamAction.isUserInTeam() and s:hasRole('admin')}">
                <li>
                  <a4j:commandLink id="Join" action="#{languageTeamAction.joinTribe}"
                    styleClass="i__item--right"
                    render="memberPanel, more-action-form" value=" #{msgs['jsf.JoinLanguageTeam']}">
                    <i class="i i--plus i__item__icon"></i>
                    <s:conversationId name="id" value="#{languageTeamAction.language}"/>
                  </a4j:commandLink>
                </li>
              </s:fragment>

              <s:fragment rendered="#{languageTeamAction.isUserInTeam()}">
                <li>
                  <a4j:commandLink id="Leave" styleClass="txt--danger i__item--right"
                    action="#{languageTeamAction.leaveTribe}"
                    render="memberPanel, more-action-form" value="#{msgs['jsf.LeaveLanguageTeam']}">
                    <i class="i i--remove i__item__icon"></i>
                    <s:conversationId name="id" value="#{languageTeamAction.language}"/>
                  </a4j:commandLink>
                </li>
              </s:fragment>

              <s:fragment rendered="#{identity.loggedIn and not languageTeamAction.isUserInTeam()}">
                <li>
                  <s:link value="#{msgs['jsf.RequestToJoinLanguageTeam']}"
                    view="/language/request_to_join_update_role.xhtml"
                    styleClass="i__item--right">
                    <f:param name="emailType" value="request_join_language"/>
                    <f:param name="id" value="#{languageTeamAction.language}"/>
                    <i class="i i--plus i__item__icon"></i>
                  </s:link>
                </li>
              </s:fragment>

              <s:fragment rendered="#{identity.loggedIn and languageTeamAction.isUserInTeam() and !(s:hasPermission(languageTeamAction.locale, 'manage-language-team'))}">
                <li>
                  <s:link  value="#{msgs['jsf.RequestUpdateRoleLanguageTeam']}"
                    view="/language/request_to_join_update_role.xhtml"
                    styleClass="i__item--right">
                    <f:param name="emailType" value="request_role_language"/>
                    <f:param name="id" value="#{languageTeamAction.language}"/>
                    <i class="i i--plus i__item__icon"></i>
                  </s:link>
                </li>
              </s:fragment>

              <s:fragment rendered="#{identity.loggedIn}">
                <li>
                  <s:link value="#{msgs['jsf.contactLanguageTeamCoordinator']}"
                    view="/language/contact_coordinator.xhtml" propagation="none"
                    styleClass="i__item--right">
                    <f:param name="emailType" value="contact_coordinator"/>
                    <f:param name="id" value="#{languageTeamAction.language}"/>
                    <i class="i i--plus i__item__icon"></i>
                  </s:link>
                </li>
              </s:fragment>

              <s:fragment rendered="#{s:hasPermission(languageTeamAction.locale, 'manage-language-team')}">
                <li>
                  <a id="addTeamMemberLink" href="#" class="i__item--right"
                    onclick="#{rich:component('userAddPanel')}.show();#{rich:element('searchField')}.focus();">
                    #{msgs['jsf.AddTeamMember']}
                    <i class="i i--plus i__item__icon"></i>
                  </a>
                </li>
              </s:fragment>
            </ul>
          </h:form>
        </s:div>
      </div>
      <h2 class="panel__heading">
        #{languageTeamAction.locale.localeId}<span
        class="txt--meta"> [#{languageTeamAction.locale.retrieveNativeName()}] <i
        class="i i--users" title="#{msgs['jsf.TeamMembers']}"></i> #{languageTeamAction.localeMembers.size}</span>
      </h2>
    </div>

    <h:form id="memberPanel" styleClass="l--push-bottom-0">
      <ul class="list--stats">
        <ui:repeat value="#{languageTeamAction.localeMembers}" var="member">
          <li class="list__item--actionable">
            <s:div styleClass="list__item__action" rendered="#{s:hasPermission(languageTeamAction.locale, 'manage-language-team')}">
              <div
                class="dropdown dropdown--small dropdown--inline dropdown--single list__item__dropdown js-dropdown">
                <a href="#" title="Options"
                  class="dropdown__toggle js-dropdown__toggle txt--meta">
                  <span class="is-invisible">Options</span>
                </a>
                <ul class="dropdown__content js-dropdown__content">
                  <li>
                    <h:commandLink value="#{msgs['jsf.Remove']}"
                      action="#{languageTeamAction.removeMembership(member)}"
                      render="memberPanel, more-action-form, userAddPanel" execute="@this"
                      styleClass="i__item--right txt--danger">
                      <i class="i i--remove i__item__icon"></i>
                    </h:commandLink>
                  </li>
                </ul>
              </div>
            </s:div>
            <div class="list__item__content">
              <div class="list__item__info">
                <h3 class="list__title">
                  #{member.person.name}
                </h3>
                    <span class="txt--meta">
                      #{member.person.account.username} [#{member.person.email}]
                    </span>
                    <span class="txt--meta l--push-left-half">
                      <span class="l--push-all-quarter">
                        #{msgs['jsf.Translator']}
                        <h:selectBooleanCheckbox value="#{member.translator}"
                          rendered="#{s:hasPermission(languageTeamAction.locale, 'manage-language-team')}">
                          <a4j:ajax event="change" execute="@this"
                            listener="#{languageTeamAction.saveTeamTranslator(member)}"/>
                        </h:selectBooleanCheckbox>
                        <s:fragment rendered="#{not s:hasPermission(languageTeamAction.locale, 'manage-language-team')}">
                          <s:fragment rendered="#{member.translator}">
                            <i class="i i--checkmark"></i>
                          </s:fragment>
                          <s:fragment rendered="#{not member.translator}">
                            <i class="i i--cancel"></i>
                          </s:fragment>
                        </s:fragment>
                      </span>

                      <span class="l--push-all-quarter">
                        #{msgs['jsf.Reviewer']}
                        <h:selectBooleanCheckbox value="#{member.reviewer}"
                          rendered="#{s:hasPermission(languageTeamAction.locale, 'manage-language-team')}">
                          <a4j:ajax event="change" execute="@this"
                            listener="#{languageTeamAction.saveTeamReviewer(member)}"/>
                        </h:selectBooleanCheckbox>
                         <s:fragment rendered="#{not s:hasPermission(languageTeamAction.locale, 'manage-language-team')}">
                           <s:fragment rendered="#{member.reviewer}">
                             <i class="i i--checkmark"></i>
                           </s:fragment>
                           <s:fragment rendered="#{not member.reviewer}">
                             <i class="i i--cancel"></i>
                           </s:fragment>
                         </s:fragment>
                      </span>

                      <span class="l--push-all-quarter">
                        #{msgs['jsf.Coordinator']}
                        <h:selectBooleanCheckbox value="#{member.coordinator}"
                          rendered="#{s:hasPermission(languageTeamAction.locale, 'manage-language-team')}">
                          <a4j:ajax event="change" execute="@this"
                            listener="#{languageTeamAction.saveTeamCoordinator(member)}"/>
                        </h:selectBooleanCheckbox>
                         <s:fragment rendered="#{not s:hasPermission(languageTeamAction.locale, 'manage-language-team')}">
                           <s:fragment rendered="#{member.coordinator}">
                             <i class="i i--checkmark"></i>
                           </s:fragment>
                           <s:fragment rendered="#{not member.coordinator}">
                             <i class="i i--cancel"></i>
                           </s:fragment>
                         </s:fragment>
                      </span>
                    </span>
              </div>
            </div>
          </li>
        </ui:repeat>
      </ul>
    </h:form>
  </div>

  <script type="text/javascript">
    function submitSearchOnEnter(e) {
      if (e.keyCode == 13) {
        #{rich:element('searchBtn')}.click();
        return false;
      }
    }
  </script>

  <rich:popupPanel id="userAddPanel" width="700" height="480">
    <h:form id="searchForm">
      <h1>#{msgs['jsf.FindUsersToAdd']}</h1>

      <div class="l--push-bottom-1">
        <h:inputText value="#{languageTeamAction.searchTerm}" id="searchField"
          onkeydown="return submitSearchOnEnter(event);"/>
        <a4j:commandButton id="searchBtn"
          value="#{msgs['jsf.Search']}"
          styleClass="button"
          action="#{languageTeamAction.searchForTeamMembers}"
          render="searchResults"
          status="searchStatus"/>
        <h:commandButton id="closeBtn" value="#{msgs['jsf.Close']}"
          action="#{languageTeamAction.clearSearchResult}"
          render="searchResults"
          styleClass="button"
          onclick="#{rich:component('userAddPanel')}.hide(); return false;"/>
      </div>
    </h:form>

    <a4j:status id="searchStatus" startText="#{msgs['jsf.Loading']}"
      stopText=""/>
    <h:form id="resultForm">
      <a4j:outputPanel id="searchResults" layout="block"
        style="overflow:auto;max-height:320px">
        <h:outputText id="noResultsMessage"
          rendered="#{empty languageTeamAction.searchResults}"
          value="No results to display."/>

        <rich:dataTable id="personTable"
          value="#{languageTeamAction.searchResults}" var="selectablePerson"
          rendered="#{not empty languageTeamAction.searchResults}">
          <rich:column sortBy="#{selectablePerson.person.name}"
            styleClass="#{selectablePerson.selected ? 'highlighted_datatable_row' : ''}">
            <f:facet name="header">#{msgs['jsf.Name']}</f:facet>
            #{selectablePerson.person.name}
          </rich:column>

          <rich:column sortBy="#{selectablePerson.person.account.username}"
            styleClass="#{selectablePerson.selected ? 'highlighted_datatable_row' : ''}">
            <f:facet name="header">#{msgs['jsf.Username']}</f:facet>
            #{selectablePerson.person.account.username}
          </rich:column>

          <rich:column width="auto"
            styleClass="#{selectablePerson.selected ? 'highlighted_datatable_row' : ''} centered">
            <f:facet name="header">#{msgs['jsf.Translator']}</f:facet>
            <h:selectBooleanCheckbox value="#{selectablePerson.translator}">
              <a4j:ajax event="change" render="searchResults"/>
            </h:selectBooleanCheckbox>
          </rich:column>

          <rich:column width="auto"
            styleClass="#{selectablePerson.selected ? 'highlighted_datatable_row' : ''} centered">
            <f:facet name="header">#{msgs['jsf.Reviewer']}</f:facet>
            <h:selectBooleanCheckbox value="#{selectablePerson.reviewer}">
              <a4j:ajax event="change" render="searchResults"/>
            </h:selectBooleanCheckbox>
          </rich:column>

          <rich:column width="auto"
            styleClass="#{selectablePerson.selected ? 'highlighted_datatable_row' : ''} centered">
            <f:facet name="header">#{msgs['jsf.Coordinator']}</f:facet>
            <h:selectBooleanCheckbox value="#{selectablePerson.coordinator}">
              <a4j:ajax event="change" render="searchResults"/>
            </h:selectBooleanCheckbox>
          </rich:column>
        </rich:dataTable>
      </a4j:outputPanel>
      <br/>
      <a4j:commandButton id="addSelectedBtn" styleClass="button button--primary"
        value="#{msgs['jsf.AddSelected']}"
        action="#{languageTeamAction.addSelected}"
        render="searchResults, memberPanel"/>
    </h:form>
  </rich:popupPanel>
</ui:composition>
