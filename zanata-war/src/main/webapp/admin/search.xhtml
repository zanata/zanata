<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
  xmlns:s="http://jboss.org/schema/seam/taglib"
  xmlns:ui="http://java.sun.com/jsf/facelets"
  xmlns:h="http://java.sun.com/jsf/html"
  xmlns:rich="http://richfaces.org/rich"
  xmlns:a4j="http://richfaces.org/a4j"
  xmlns:zanata="http://java.sun.com/jsf/composite/zanata"
  template="../WEB-INF/template/template.xhtml">

  <ui:define name="page_title">#{msgs['jsf.ManageSearch']}</ui:define>

  <ui:define name="center_content">
    <div class="g">
      <div class="g__item w--1-m w--3-8-l w--1-3 l--push-bottom-half">
        <p class="txt--meta l--push-all-0">
          <s:link view="/admin/home.xhtml" propagation="none"
            value="#{msgs['jsf.Administration']}"/>
        </p>

        <div class="l--push-bottom-half">
          <h1 class="l--push-all-0">
            <i class="i--small i--search txt--neutral i--left"></i>
            #{msgs['jsf.ManageSearch']}
          </h1>
        </div>

        <s:div styleClass="panel l--push-top-1" id="progress">
          <div class="panel__header">
            <s:div styleClass="panel__header__actions l--push-right-half l--push-bottom-0"
              rendered="#{reindexAction.inProgress and !reindexAction.canceled}">
              <h:form styleClass="l--push-bottom-0">
                <a4j:commandLink id="cancel" styleClass="button--small button--link"
                  value="#{msgs['jsf.ManageSearch.Abort']}"
                  action="#{reindexAction.cancel}" render="actions,progress"/>
              </h:form>
            </s:div>
            <h2 class="panel__heading--small">#{msgs['jsf.ManageSearch.CurrentProgress']}</h2>
          </div>

          <div class="l--pad-all-half">
            <s:fragment rendered="#{!reindexAction.inProgress}">
              <p id="noOperationsRunning" class="txt--meta">
                <h:outputText escape="false"
                  value="#{msgs['jsf.ManageSearch.NoOperationsRunning']}" />
              </p>
            </s:fragment>
            <s:fragment rendered="#{reindexAction.reindexedSinceServerRestart and !reindexAction.inProgress and !reindexAction.canceled and !reindexAction.error}">
              <p id="completed" class="txt--meta">
                <h:outputText
                  value="#{msgs.format('jsf.ManageSearch.Completed', reindexAction.elapsedTime)}" />
              </p>
            </s:fragment>
            <s:fragment rendered="#{reindexAction.canceled}">
              <p id="aborted" class="txt--meta">
                <h:outputText escape="false"
                  value="#{msgs.format('jsf.ManageSearch.Aborted', reindexAction.elapsedTime)}" />
              </p>
            </s:fragment>
            <s:fragment rendered="#{reindexAction.error}">
              <p class="txt--meta txt--danger">
                <h:outputText escape="false"
                  value="#{msgs['jsf.manageSearch.ErrorMessage']}" />
                <br/>
                <h:outputText escape="false"
                  value="#{msgs['jsf.manageSearch.PleaseReindex']}" />
              </p>
            </s:fragment>

            <a4j:outputPanel>
              <a4j:poll render="progress,actions" enabled="#{reindexAction.inProgress}"/>

              <s:fragment rendered="#{reindexAction.inProgress}">
                <zanata:loader layout="inline"/>
                <span class="txt--understated l--push-h-quarter">#{reindexAction.progressPercentage}%</span>
                <span class="txt--meta l--push-bottom-half">
                  #{msgs.format('jsf.manageSearch.ProgressMessage', reindexAction.reindexProgress, reindexAction.reindexCount)}
                </span>
              </s:fragment>
            </a4j:outputPanel>

            <div class="l--push-top-half">
              <s:fragment rendered="#{(reindexAction.inProgress || reindexAction.canceled || reindexAction.error) and reindexAction.currentClass ne 'none'}">
                <p class="txt--meta">
                  <h:outputText
                    value="#{msgs.format('jsf.manageSearch.CurrentTable', reindexAction.currentClass)}" />
                </p>
              </s:fragment>
              <s:fragment rendered="#{reindexAction.inProgress}">
                <p class="txt--meta">
                  <h:outputText
                    value="#{msgs.format('jsf.ManageSearch.ElapsedTime', reindexAction.elapsedTime)}" />
                  <br/>
                  <h:outputText
                    value="#{msgs.format('jsf.ManageSearch.RemainingTime', reindexAction.estimatedTimeRemaining)}" />
                </p>
              </s:fragment>
            </div>
          </div>
        </s:div>
      </div>

      <div class="g__item w--1-m w--5-8-l w--2-3">
        <h:form id="form">
          <s:token allowMultiplePosts="true"/>
            <s:div id="actions">
                <table class="bg--pop-highest l--push-bottom-1">
                  <thead>
                    <tr>
                      <th class="l--pad-v-half">#{msgs['jsf.manageSearch.Table']}</th>
                      <th class="l--pad-v-half">
                        <h:selectBooleanCheckbox value="#{reindexAction.purgeAll}"
                          disabled="#{not reindexAction.canceled and reindexAction.inProgress}">
                          <a4j:ajax event="click" render="actions" execute="@this"/>
                        </h:selectBooleanCheckbox>
                        <s:span styleClass="l--push-left-half">
                          #{msgs['jsf.manageSearch.purge']} <i class="i i--info txt--meta"></i>
                          <rich:tooltip showDelay="800">
                            <p>#{msgs['jsf.manageSearch.purge.Description']}</p>

                            <p>#{msgs['jsf.manageSearch.purge.ObsoletesOccupyDiskSpace']}</p>

                            <p>#{msgs['jsf.manageSearch.purge.RemoveByRunningOptimize']}</p>
                          </rich:tooltip>
                        </s:span>
                      </th>
                      <th class="l--pad-v-half">
                        <h:selectBooleanCheckbox value="#{reindexAction.reindexAll}" id="reindexAllChk"
                          disabled="#{not reindexAction.canceled and reindexAction.inProgress}">
                          <a4j:ajax event="click" render="actions" execute="@this"/>
                        </h:selectBooleanCheckbox>
                        <s:span styleClass="l--push-left-half">
                          #{msgs['jsf.manageSearch.reindex']} <i class="i i--info txt--meta"></i>
                          <rich:tooltip showDelay="800">
                            <p>#{msgs['jsf.manageSearch.reindex.Description']}</p>

                            <p>#{msgs['jsf.manageSearch.reindex.OnlyWhenOutOfDate']}</p>

                            <p>#{msgs['jsf.manageSearch.reindex.AllRowsWillBeReindexed']}</p>

                            <p>#{msgs['jsf.manageSearch.reindex.IndexedRowsWillBeUpdated']}</p>
                            <p>
                              <em>#{msgs['jsf.manageSearch.reindex.TimeAndMemoryWarning']}</em>
                            </p>
                            <p>
                              <em>#{msgs['jsf.manageSearch.reindex.RunDuringOffPeak']}</em>
                            </p>
                          </rich:tooltip>
                        </s:span>
                      </th>
                      <th class="l--pad-v-half">
                        <h:selectBooleanCheckbox value="#{reindexAction.optimizeAll}"
                          disabled="#{not reindexAction.canceled and reindexAction.inProgress}">
                          <a4j:ajax event="click" render="actions" execute="@this"/>
                        </h:selectBooleanCheckbox>
                        <s:span styleClass="l--push-left-half">
                          #{msgs['jsf.manageSearch.optimize']} <i class="i i--info txt--meta"></i>
                          <rich:tooltip showDelay="800">
                            <p>#{msgs['jsf.manageSearch.optimize.Description']}</p>

                            <p>#{msgs['jsf.manageSearch.optimize.RemovesObsoleteEntries']}</p>

                            <p>#{msgs['jsf.manageSearch.optimize.WillNotInfluenceIndexTime']}</p>

                            <p>
                              <em>#{msgs['jsf.manageSearch.optimize.TempFileWarning']}</em>
                            </p>
                          </rich:tooltip>
                        </s:span>
                      </th>
                    </tr>
                  </thead>
                  <tbody class="bg--high">
                    <ui:repeat value="#{reindexAction.classes.toArray()}" var="clazz">
                      <tr class="bg--higher--hover">
                        <td class="l--pad-v-half">
                          <h:selectBooleanCheckbox value="#{clazz.selectAll}"
                            disabled="#{not reindexAction.canceled and reindexAction.inProgress}">
                            <a4j:ajax event="click" render="actions" execute="@this"/>
                          </h:selectBooleanCheckbox>
                          <span class="l--push-left-half"><h:outputText value="#{clazz.className}"/></span>
                        </td>
                        <td class="l--pad-v-half">
                          <h:selectBooleanCheckbox value="#{clazz.purge}" execute="@this"
                            disabled="#{not reindexAction.canceled and reindexAction.inProgress}">
                            <a4j:ajax event="click" render="actions" execute="@this"/>
                          </h:selectBooleanCheckbox>
                        </td>
                        <td class="l--pad-v-half">
                          <h:selectBooleanCheckbox value="#{clazz.reindex}"
                            disabled="#{not reindexAction.canceled and reindexAction.inProgress}">
                            <a4j:ajax event="click" render="actions" execute="@this"/>
                          </h:selectBooleanCheckbox>
                        </td>
                        <td class="l--pad-v-half">
                          <h:selectBooleanCheckbox value="#{clazz.optimize}"
                            disabled="#{not reindexAction.canceled and reindexAction.inProgress}">
                            <a4j:ajax event="click" render="actions" execute="@this"/>
                          </h:selectBooleanCheckbox>
                        </td>
                      </tr>
                    </ui:repeat>
                  </tbody>
                </table>

                <a4j:commandButton id="selectNone"
                  disabled="#{not reindexAction.canceled and reindexAction.inProgress}"
                  value="#{msgs['jsf.ManageSearch.SelectNone']}"
                  action="#{reindexAction.selectAll(false)}"
                  render="actions" styleClass="button"/>

                <a4j:commandButton id="selectAll"
                disabled="#{not reindexAction.canceled and reindexAction.inProgress}"
                value="#{msgs['jsf.ManageSearch.SelectAll']}"
                action="#{reindexAction.selectAll(true)}"
                render="actions" styleClass="button l--push-h-quarter"/>

                <a4j:commandButton id="reindex"
                  disabled="#{not reindexAction.canceled and reindexAction.inProgress}"
                  value="#{msgs['jsf.ManageSearch.PerformSelectedActions']}"
                  action="#{reindexAction.reindexDatabase}"
                  render="actions,progress" styleClass="button"/>
              </s:div>
        </h:form>
      </div>
    </div>
  </ui:define>

</ui:composition>
